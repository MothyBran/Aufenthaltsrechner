<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Schengen Aufenthaltsrechner 2025 | 90/180 Tage Regel + Visum Checker</title>
    <meta name="description" content="Kostenloser Schengen Aufenthaltsrechner 2025: Berechnen Sie Ihre verbleibenden Aufenthaltstage im Schengen-Raum. 90/180-Tage-Regel + Visum-Pr√ºfung. F√ºr Touristen, digitale Nomaden und Gesch√§ftsreisende.">
    <meta name="keywords" content="Schengen Aufenthaltsrechner, 90 Tage Regel, 180 Tage Regel, Schengen Visum, Aufenthaltstage berechnen, EU Reisen, Visum Checker, digitale Nomaden, Gesch√§ftsreise, Tourist Visum, Schengen Zone, Ein- Ausreise, Aufenthaltsdauer">
    <meta name="author" content="Schengen Aufenthaltsrechner">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="language" content="de">
    <meta name="geo.region" content="EU">
    <meta name="geo.placename" content="Europa, Schengen-Raum">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://example.com/schengen-aufenthaltsrechner">

    <!-- Language Alternatives -->
    <link rel="alternate" hreflang="de" href="https://example.com/schengen-aufenthaltsrechner">
    <link rel="alternate" hreflang="en" href="https://example.com/en/schengen-stay-calculator">
    <link rel="alternate" hreflang="x-default" href="https://example.com/schengen-aufenthaltsrechner">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Schengen Aufenthaltsrechner 2025 | 90/180 Tage Regel + Visum Checker">
    <meta property="og:description" content="Kostenloser Schengen Aufenthaltsrechner: Berechnen Sie Ihre verbleibenden Aufenthaltstage im Schengen-Raum. 90/180-Tage-Regel + Visum-Pr√ºfung f√ºr Touristen und digitale Nomaden.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/schengen-aufenthaltsrechner">
    <meta property="og:image" content="https://example.com/images/schengen-calculator-preview.jpg">
    <meta property="og:image:alt" content="Schengen Aufenthaltsrechner - 90/180 Tage Regel berechnen">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Schengen Aufenthaltsrechner">
    <meta property="og:locale" content="de_DE">
    <meta property="og:locale:alternate" content="en_US">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Schengen Aufenthaltsrechner 2025 | 90/180 Tage Regel">
    <meta name="twitter:description" content="Kostenloser Rechner f√ºr Schengen-Aufenthaltstage. Berechnen Sie Ihre verbleibenden Tage nach der 90/180-Regel + Visum-Pr√ºfung.">
    <meta name="twitter:image" content="https://example.com/images/schengen-calculator-preview.jpg">
    <meta name="twitter:image:alt" content="Schengen Aufenthaltsrechner Interface">
    <meta name="twitter:site" content="@SchengenCalc">
    <meta name="twitter:creator" content="@SchengenCalc">

    <!-- Additional SEO Meta Tags -->
    <meta name="application-name" content="Schengen Aufenthaltsrechner">
    <meta name="theme-color" content="#4facfe">
    <meta name="msapplication-TileColor" content="#4facfe">
    <meta name="apple-mobile-web-app-title" content="Schengen Rechner">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Schengen Aufenthaltsrechner",
        "description": "Kostenloser Online-Rechner zur Berechnung der verbleibenden Aufenthaltstage im Schengen-Raum nach der 90/180-Tage-Regel",
        "url": "https://example.com/schengen-aufenthaltsrechner",
        "applicationCategory": "TravelApplication",
        "operatingSystem": "Web Browser",
        "permissions": "Keine Registrierung erforderlich",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
        },
        "author": {
            "@type": "Organization",
            "name": "Schengen Aufenthaltsrechner"
        },
        "provider": {
            "@type": "Organization",
            "name": "Schengen Aufenthaltsrechner"
        },
        "inLanguage": ["de", "en"],
        "keywords": "Schengen, Aufenthaltsrechner, 90 Tage Regel, 180 Tage, Visum, EU Reisen",
        "audience": {
            "@type": "Audience",
            "audienceType": "Tourists, Digital Nomads, Business Travelers"
        },
        "featureList": [
            "90/180-Tage-Regel Berechnung",
            "Visum-Compliance Pr√ºfung", 
            "Ein- und Ausreisedaten Verwaltung",
            "PDF Export Funktion",
            "Mehrsprachige Unterst√ºtzung"
        ]
    }
    </script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8284978389895352"
         crossorigin="anonymous"></script>

    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- DNS Prefetch for External Resources -->
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-btn {
            padding: 8px 16px;
            border: 2px solid #4facfe;
            background: white;
            color: #4facfe;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .language-btn.active {
            background: #4facfe;
            color: white;
        }

        .mode-switch {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4facfe;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .mode-labels {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            color: #495057;
        }

        .period-display {
            background: linear-gradient(135deg, #e8f4fd 0%, #f0f9ff 100%);
            border-top: 1px solid #e3f2fd;
            border-bottom: 1px solid #e3f2fd;
            padding: 20px 30px;
        }

        .period-content {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
        }

        .period-content h3 {
            color: #1565c0;
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .period-dates {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0d47a1;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .period-note {
            color: #1976d2;
            font-size: 0.9rem;
            font-style: italic;
            opacity: 0.8;
        }

        .control-date {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #1565c0;
        }

        .control-date label {
            font-weight: 600;
        }

        .control-date input {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #90caf9;
            font-size: 0.9rem;
            min-width: 160px;
        }

        .content {
            padding: 30px;
        }

        .mode-section {
            display: none;
        }

        .mode-section.active {
            display: block;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #424242;
            line-height: 1.5;
        }

        .visa-config {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .visa-config h3 {
            color: #e65100;
            margin-bottom: 15px;
        }

        .visa-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .entries-section, .exits-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .entries-section h3, .exits-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .entries-grid, .exits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .entry-item, .exit-item {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .entry-item:hover, .exit-item:hover {
            border-color: #4facfe;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.1);
        }

        .entry-header, .exit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .entry-header label, .exit-header label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .delete-entry-btn, .delete-exit-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-entry-btn:hover, .delete-exit-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .entry-item input, .exit-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .entry-item input:focus, .exit-item input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.1);
        }

        .add-entry-section, .add-exit-section {
            display: flex;
            justify-content: center;
            align-items: center;
            grid-column: 1 / -1;
        }

        .add-entry-btn, .add-exit-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: 2px dashed #dee2e6;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-entry-btn:hover, .add-exit-btn:hover {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .calculated-stays-container {
            margin-top: 30px;
        }

        .calculated-stays {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 20px;
        }

        .calculated-stays h3 {
            color: #155724;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .stays-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* NEU: Stil f√ºr unvollst√§ndige/erg√§nzte Zeitr√§ume */
.calculated-stay-item.stay-incomplete {
    border: 2px solid #dc3545;
    background-color: #fff5f5;
}

.stay-incomplete-badge {
    color: #dc3545;
    font-size: 0.8rem;
    font-weight: bold;
    display: block;
    margin-top: 4px;
}

        .calculated-stay-item {
            background: white;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stay-number {
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .stay-details {
            flex: 1;
        }

        .stay-period {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .stay-duration {
            color: #28a745;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calculated-stays-empty {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .results.hidden {
            display: none;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: 600;
            color: #495057;
        }

        .result-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .status-legal {
            color: #28a745;
        }

        .status-illegal {
            color: #dc3545;
        }

        .status-warning {
            color: #ffc107;
        }

        .next-entry-date {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }

        .print-section {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .print-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .footer {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-top: 1px solid #dee2e6;
            margin-top: 40px;
        }

        .footer-content {
            padding: 40px 30px;
            max-width: 800px;
            margin: 0 auto;
            color: #495057;
            line-height: 1.6;
        }

        .footer-content h2 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .footer-content h3 {
            color: #34495e;
            font-size: 1.2rem;
            margin: 25px 0 15px 0;
            font-weight: 600;
        }

        .intro-text {
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 500;
        }

        .features-text {
            margin-bottom: 10px;
            font-weight: 500;
        }

        .feature-list {
            margin-bottom: 30px;
            padding-left: 20px;
        }

        .feature-list li {
            margin-bottom: 8px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .section ul li {
            margin-bottom: 8px;
        }

        .benefits {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .benefits p {
            margin-bottom: 8px;
            font-weight: 600;
            color: #155724;
        }

        .benefits p:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .content {
                padding: 20px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .period-display {
                padding: 15px 20px;
            }

            .period-dates {
                font-size: 1.1rem;
            }

            .mode-switch {
                justify-content: center;
            }

            .visa-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .entries-grid, .exits-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .calculated-stay-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .stay-details {
                order: 1;
            }

            .stay-number {
                order: 2;
                align-self: center;
            }

            .result-item {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }

            .footer-content {
                padding: 30px 20px;
            }

            .footer-content h2 {
                font-size: 1.3rem;
            }

            .footer-content h3 {
                font-size: 1.1rem;
            }

            .intro-text {
                font-size: 1rem;
            }

            .print-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="headerTitle">üá™üá∫ Schengen & Visa Aufenthaltsrechner</h1>
            <p id="headerSubtitle">Berechnen Sie Ihre verbleibenden Aufenthaltstage</p>
        </div>

        <div class="controls">
            <div class="language-selector">
                <span id="languageLabel">Sprache:</span>
                <button class="language-btn active" onclick="setLanguage('de')">üá©üá™ DE</button>
                <button class="language-btn" onclick="setLanguage('en')">üá¨üáß EN</button>
            </div>

            <div class="mode-switch">
                <div class="mode-labels">
                    <span id="mode1Label">Schengen 90/180</span>
                    <label class="switch">
                        <input type="checkbox" id="modeSwitch" onchange="toggleMode()">
                        <span class="slider"></span>
                    </label>
                    <span id="mode2Label">Visum-Pr√ºfung</span>
                </div>
            </div>
        </div>

        <div class="period-display" id="periodDisplay">
            <div class="period-content">
                <h3 id="calculationPeriodTitle">üìÖ Aktueller Berechnungszeitraum</h3>
                <div class="period-dates" id="periodDates">
                    <span id="periodStart">-</span> ‚Üí <span id="periodEnd">-</span>
                </div>
                <div class="period-note" id="periodNote">
                    Aufenthalte in diesem 180-Tage-Zeitraum werden ber√ºcksichtigt
                </div>
                <div class="control-date">
                    <label for="controlDateInput" id="controlDateLabel">
                        Kontrolldatum (Berechnung ab):
                    </label>
                    <input type="date" id="controlDateInput" onchange="updatePeriodDisplay()">
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Schengen Mode -->
            <div id="schengenMode" class="mode-section active">
                <div class="info-box">
                    <h3 id="schengenRuleTitle">Schengen-Regel (90/180 Tage)</h3>
                    <p id="schengenRuleText">Als Tourist d√ºrfen Sie sich maximal <strong>90 Tage</strong> innerhalb von <strong>180 aufeinanderfolgenden Tagen</strong> im Schengen-Raum aufhalten. Geben Sie Ihre Ein- und Ausreisedaten ein, um Ihre verbleibenden Tage zu berechnen.</p>
                </div>

                <div id="schengenStayEntries"></div>

                <button type="button" class="calculate-btn" onclick="calculateSchengen()" id="schengenCalculateBtn">
                    üìä Aufenthaltstage berechnen
                </button>
            </div>

            <!-- Visa Mode -->
            <div id="visaMode" class="mode-section">
                <div class="info-box">
                    <h3 id="visaRuleTitle">Visum-Zeitraum Pr√ºfung</h3>
                    <p id="visaRuleText">Geben Sie Ihre Visum-Details ein und pr√ºfen Sie, ob Ihre geplanten Aufenthalte innerhalb der Visum-Beschr√§nkungen liegen.</p>
                </div>

                <div class="visa-config">
                    <h3 id="visaConfigTitle">üõÇ Visum-Konfiguration</h3>
                    <div class="visa-inputs">
                        <div class="input-group">
                            <label for="visaStart" id="visaStartLabel">Visum g√ºltig ab</label>
                            <input type="date" id="visaStart" onchange="updatePeriodDisplay()">
                        </div>
                        <div class="input-group">
                            <label for="visaEnd" id="visaEndLabel">Visum g√ºltig bis</label>
                            <input type="date" id="visaEnd" onchange="updatePeriodDisplay()">
                        </div>
                        <div class="input-group">
                            <label for="allowedDays" id="allowedDaysLabel">Erlaubte Aufenthaltstage</label>
                            <input type="number" id="allowedDays" min="1" max="365" placeholder="z.B. 90">
                        </div>
                        <div class="input-group">
                            <label for="allowedEntries" id="allowedEntriesLabel">Erlaubte Einreisen</label>
                            <select id="allowedEntries">
                                <option value="1" id="singleEntry">1 (Einmalig)</option>
                                <option value="2" id="doubleEntry">2 (Zweimalig)</option>
                                <option value="multi" id="multiEntry">MULTI (Mehrfach)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="visaStayEntries"></div>

                <button type="button" class="calculate-btn" onclick="calculateVisa()" id="visaCalculateBtn">
                    üîç Visum-Compliance pr√ºfen
                </button>
            </div>

            <div id="results" class="results hidden">
                <h3 id="resultsTitle" style="margin-bottom: 20px; color: #495057;">üîç Berechnungsergebnis</h3>
                <div id="resultsList"></div>
                <div class="print-section">
                    <button type="button" class="print-btn" onclick="printResults()" id="printBtn">
                        üìÑ <span id="printBtnText">Drucken/Exportieren</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <h2 id="footerTitle">üõÇ Aufenthaltsrechner f√ºr Schengen | 90 Tage in 180 Tagen + Visumspr√ºfung</h2>

                <p class="intro-text" id="footerIntro">
                    Mit unserem kostenlosen Aufenthaltsrechner kannst du ganz einfach pr√ºfen, wie viele Aufenthaltstage im Schengen-Raum du bereits verbraucht hast, wie viele Tage dir noch bleiben ‚Äì und ob du aktuell legal eingereist bist.
                </p>

                <p class="features-text" id="footerFeatures">
                    Die Berechnung ber√ºcksichtigt sowohl:
                </p>

                <ul class="feature-list">
                    <li><strong id="footerFeature1">die klassische 90/180-Tage-Regel</strong> (f√ºr visumfreies Reisen)</li>
                    <li><strong id="footerFeature2">als auch Aufenthaltszeiten innerhalb eines Schengen-Visums</strong> (z. B. Typ-C-Visum mit begrenztem G√ºltigkeitszeitraum)</li>
                </ul>

                <div class="section">
                    <h3 id="footerWhatTitle">üîç Was macht unser Aufenthaltsrechner?</h3>
                    <ul>
                        <li id="footerWhat1">Berechnet automatisch, wie viele Tage du im aktuellen 180-Tage-Zeitraum verbracht hast</li>
                        <li id="footerWhat2">Zeigt, wie viele Aufenthaltstage noch √ºbrig sind</li>
                        <li id="footerWhat3">Pr√ºft bei Bedarf auch, ob du dein Schengen-Visum korrekt nutzt</li>
                        <li id="footerWhat4">Gibt an, ab wann eine erneute legale Einreise m√∂glich ist</li>
                    </ul>
                    <p id="footerWhatNote">Du gibst einfach deine einzelnen Ein- und Ausreisedaten ein ‚Äì alles andere √ºbernimmt das Tool.</p>
                </div>

                <div class="section">
                    <h3 id="footerWhoTitle">üë§ F√ºr wen ist der Rechner n√ºtzlich?</h3>
                    <ul>
                        <li id="footerWho1">Touristen mit visumfreier Einreise (z. B. aus UK, USA, Kanada, Australien)</li>
                        <li id="footerWho2">Visa-Inhaber, die ihre 90 Tage im Visumszeitraum einhalten m√ºssen</li>
                        <li id="footerWho3">Digitale Nomaden, Gesch√§ftsreisende, Au-Pairs</li>
                        <li id="footerWho4">Alle, die rechtssicher im Schengen-Raum reisen m√∂chten</li>
                    </ul>
                </div>

                <div class="benefits">
                    <p id="footerBenefit1">‚úî Die Berechnung erfolgt direkt im Browser ‚Äì keine Datenspeicherung, keine Anmeldung n√∂tig.</p>
                    <p id="footerBenefit2">‚úî Ideal zur Planung, Dokumentation oder zum Nachweis gegen√ºber Beh√∂rden.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLanguage = 'de';
        let currentMode = 'schengen';
        let visibleEntries = 1;
        let visibleExits = 1;
        let calculationPeriodData = null;

        // Funktion f√ºr korrektes Datum in mitteleurop√§ischer Zeit
        function getTodayMEZ() {
            const now = new Date();
            // Konvertierung zu MEZ/MESZ (UTC+1/UTC+2)
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            const mezTime = new Date(utcTime + (1 * 3600000)); // UTC+1 (MEZ)

            // Pr√ºfung auf Sommerzeit (MESZ = UTC+2)
            const year = mezTime.getFullYear();
            const marchLastSunday = new Date(year, 2, 31 - ((new Date(year, 2, 31).getDay() + 6) % 7));
            const octoberLastSunday = new Date(year, 9, 31 - ((new Date(year, 9, 31).getDay() + 6) % 7));

            if (now >= marchLastSunday && now < octoberLastSunday) {
                // Sommerzeit (MESZ = UTC+2)
                return new Date(utcTime + (2 * 3600000));
            } else {
                // Winterzeit (MEZ = UTC+1)
                return mezTime;
            }
        }

        // Funktion f√ºr MEZ-Datum ohne Zeitanteil (nur Jahr-Monat-Tag)
        function getTodayMEZDateOnly() {
            const mezToday = getTodayMEZ();
            return new Date(mezToday.getFullYear(), mezToday.getMonth(), mezToday.getDate());
        }

        function getControlDate() {
            const input = document.getElementById('controlDateInput');
            if (input && input.value) {
                const d = new Date(input.value);
                return new Date(d.getFullYear(), d.getMonth(), d.getDate());
            }
            return getTodayMEZDateOnly();
        }

        const translations = {
            de: {
                headerTitle: 'üá™üá∫ Schengen & Visa Aufenthaltsrechner',
                headerSubtitle: 'Berechnen Sie Ihre verbleibenden Aufenthaltstage',
                languageLabel: 'Sprache:',
                mode1Label: 'Schengen 90/180',
                mode2Label: 'Visum-Pr√ºfung',
                schengenRuleTitle: 'Schengen-Regel (90/180 Tage)',
                schengenRuleText: 'Als Tourist d√ºrfen Sie sich maximal <strong>90 Tage</strong> innerhalb von <strong>180 aufeinanderfolgenden Tagen</strong> im Schengen-Raum aufhalten. Geben Sie Ihre Ein- und Ausreisedaten ein, um Ihre verbleibenden Tage zu berechnen.',
                visaRuleTitle: 'Visum-Zeitraum Pr√ºfung',
                visaRuleText: 'Geben Sie Ihre Visum-Details ein und pr√ºfen Sie, ob Ihre geplanten Aufenthalte innerhalb der Visum-Beschr√§nkungen liegen.',
                visaConfigTitle: 'üõÇ Visum-Konfiguration',
                visaStartLabel: 'Visum g√ºltig ab',
                visaEndLabel: 'Visum g√ºltig bis',
                allowedDaysLabel: 'Erlaubte Aufenthaltstage',
                allowedEntriesLabel: 'Erlaubte Einreisen',
                schengenCalculateBtn: 'üìä Aufenthaltstage berechnen',
                visaCalculateBtn: 'üîç Visum-Compliance pr√ºfen',
                printBtnText: 'Drucken/Exportieren',
                addEntryBtn: '+ Einreise hinzuf√ºgen',
                addExitBtn: '+ Ausreise hinzuf√ºgen',
                entryHeading: 'Einreisen',
                exitHeading: 'Ausreisen',
                entryLabel: 'Einreise',
                exitLabel: 'Ausreise',
                calculatedStaysTitle: 'Berechnete Aufenthaltszeiten',
                emptyStaysMessage: 'Geben Sie Ein- und Ausreisedaten ein, um Aufenthaltszeiten zu berechnen.',
                stayOverviewTitle: 'Eingegebene Aufenthalte',
                calculationPeriodTitle: 'Aktueller Berechnungszeitraum',
                calculationPeriodSchengen: 'Aufenthalte in diesem 180-Tage-Zeitraum werden ber√ºcksichtigt',
                calculationPeriodVisa: 'Bitte Visum-Daten eingeben um Zeitraum anzuzeigen',
                today: 'Heute',
                todayMEZ: 'Heute MEZ',
                resultsTitle: 'üîç Berechnungsergebnis',
                stayLabel: 'Aufenthalt',
                arrivalLabel: 'Ankunftsdatum',
                departureLabel: 'Abreisedatum',
                daysText: 'Tag',
                daysTextPlural: 'Tage',
                usedDaysLabel: 'üìä Genutzte Aufenthaltstage (180-Tage-Zeitraum)',
                usedDaysVisaLabel: 'üìä Genutzte Aufenthaltstage (Visum-Zeitraum)',
                remainingDaysLabel: '‚è∞ Verbleibende Aufenthaltstage',
                allowedStayUntilLabel: 'üìÜ Erlaubter Aufenthalt bis',
                statusLabel: '‚öñÔ∏è Aktueller Status',
                calculationDateLabel: 'üìÖ Berechnungsstichtag',
                entriesUsedLabel: 'üö™ Verwendete Einreisen',
                statusLegal: '‚úÖ Legal',
                statusExhausted: '‚ö†Ô∏è Ausgesch√∂pft (0 Tage √ºbrig)',
                statusViolation: '‚ùå √úberschreitung',
                statusVisaValid: '‚úÖ Visum-konform',
                statusVisaViolation: '‚ùå Visum-Verletzung',
                nextEntryText: 'üö™ N√§chstm√∂gliche legale Einreise:',
                errorEndDate: '‚ö†Ô∏è Enddatum muss nach Startdatum liegen',
                errorNoStays: 'Bitte geben Sie mindestens einen Aufenthaltszeitraum ein.',
                errorVisaConfig: 'Bitte f√ºllen Sie alle Visum-Felder aus.',
                errorVisaDates: 'Visum-Enddatum muss nach Startdatum liegen.',
                errorStayOutsideVisa: '‚ö†Ô∏è Aufenthalt au√üerhalb des Visum-Zeitraums',
                tooManyEntries: 'Zu viele Einreisen',
                daysOverLimit: 'Tage √ºberschritten',
                violationsTitle: 'Verst√∂√üe',
                remaining: '√ºbrig',
                placeholder90: 'z.B. 90',
                singleEntry: '1 (Einmalig)',
                doubleEntry: '2 (Zweimalig)',
                multiEntry: 'MULTI (Mehrfach)',
                visaPeriodLabel: 'Visum-Zeitraum',
                createdOn: 'Erstellt am',
                pageInfo: 'Seite 1 von 1',
                createdWith: 'Erstellt mit: Schengen Aufenthaltsrechner',
                disclaimer: 'Hinweis: Diese Berechnung dient zur Orientierung. Bei rechtlichen Fragen wenden Sie sich an die zust√§ndigen Beh√∂rden.',
                footerTitle: 'üõÇ Aufenthaltsrechner f√ºr Schengen | 90 Tage in 180 Tagen + Visumspr√ºfung',
                footerIntro: 'Mit unserem kostenlosen Aufenthaltsrechner kannst du ganz einfach pr√ºfen, wie viele Aufenthaltstage im Schengen-Raum du bereits verbraucht hast, wie viele Tage dir noch bleiben ‚Äì und ob du aktuell legal eingereist bist.',
                footerFeatures: 'Die Berechnung ber√ºcksichtigt sowohl:',
                footerFeature1: 'die klassische 90/180-Tage-Regel (f√ºr visumfreies Reisen)',
                footerFeature2: 'als auch Aufenthaltszeiten innerhalb eines Schengen-Visums (z. B. Typ-C-Visum mit begrenztem G√ºltigkeitszeitraum)',
                footerWhatTitle: 'üîç Was macht unser Aufenthaltsrechner?',
                footerWhat1: 'Berechnet automatisch, wie viele Tage du im aktuellen 180-Tage-Zeitraum verbracht hast',
                footerWhat2: 'Zeigt, wie viele Aufenthaltstage noch √ºbrig sind',
                footerWhat3: 'Pr√ºft bei Bedarf auch, ob du dein Schengen-Visum korrekt nutzt',
                footerWhat4: 'Gibt an, ab wann eine erneute legale Einreise m√∂glich ist',
                footerWhatNote: 'Du gibst einfach deine einzelnen Ein- und Ausreisedaten ein ‚Äì alles andere √ºbernimmt das Tool.',
                footerWhoTitle: 'üë§ F√ºr wen ist der Rechner n√ºtzlich?',
                footerWho1: 'Touristen mit visumfreier Einreise (z. B. aus UK, USA, Kanada, Australien)',
                footerWho2: 'Visa-Inhaber, die ihre 90 Tage im Visumszeitraum einhalten m√ºssen',
                footerWho3: 'Digitale Nomaden, Gesch√§ftsreisende, Au-Pairs',
                footerWho4: 'Alle, die rechtssicher im Schengen-Raum reisen m√∂chten',
                footerBenefit1: '‚úî Die Berechnung erfolgt direkt im Browser ‚Äì keine Datenspeicherung, keine Anmeldung n√∂tig.',
                footerBenefit2: '‚úî Ideal zur Planung, Dokumentation oder zum Nachweis gegen√ºber Beh√∂rden.',
                controlDateLabel: 'Kontrolldatum (Berechnung ab):',
                incompleteDataWarning: 'Die Eingaben enthalten unvollst√§ndige Aufenthalte (fehlende Ein- oder Ausreisedaten). Fehlende Ausreisen werden bis zur n√§chsten Einreise bzw. bis zum Kontrolldatum angenommen.'
            },
            en: {
                headerTitle: 'üá™üá∫ Schengen & Visa Stay Calculator',
                headerSubtitle: 'Calculate your remaining stay days',
                languageLabel: 'Language:',
                mode1Label: 'Schengen 90/180',
                mode2Label: 'Visa Check',
                schengenRuleTitle: 'Schengen Rule (90/180 days)',
                schengenRuleText: 'As a tourist, you may stay a maximum of <strong>90 days</strong> within <strong>180 consecutive days</strong> in the Schengen area. Enter your entry and exit dates to calculate your remaining days.',
                visaRuleTitle: 'Visa Period Check',
                visaRuleText: 'Enter your visa details and check if your planned stays are within the visa restrictions.',
                visaConfigTitle: 'üõÇ Visa Configuration',
                visaStartLabel: 'Visa valid from',
                visaEndLabel: 'Visa valid until',
                allowedDaysLabel: 'Allowed stay days',
                allowedEntriesLabel: 'Allowed entries',
                schengenCalculateBtn: 'üìä Calculate stay days',
                visaCalculateBtn: 'üîç Check visa compliance',
                printBtnText: 'Print/Export',
                addEntryBtn: '+ Add entry',
                addExitBtn: '+ Add exit',
                entryHeading: 'Entries',
                exitHeading: 'Exits',
                entryLabel: 'Entry',
                exitLabel: 'Exit',
                calculatedStaysTitle: 'Calculated stay periods',
                emptyStaysMessage: 'Enter entry and exit dates to calculate stay periods.',
                stayOverviewTitle: 'Entered stays',
                calculationPeriodTitle: 'Current calculation period',
                calculationPeriodSchengen: 'Stays within this 180-day period are considered',
                calculationPeriodVisa: 'Please enter visa data to display period',
                today: 'Today',
                todayMEZ: 'Today CET',
                resultsTitle: 'üîç Calculation Result',
                stayLabel: 'Stay',
                arrivalLabel: 'Arrival date',
                departureLabel: 'Departure date',
                daysText: 'day',
                daysTextPlural: 'days',
                usedDaysLabel: 'üìä Used stay days (180-day period)',
                usedDaysVisaLabel: 'üìä Used stay days (visa period)',
                remainingDaysLabel: '‚è∞ Remaining stay days',
                allowedStayUntilLabel: 'üìÜ Allowed stay until',
                statusLabel: '‚öñÔ∏è Current status',
                calculationDateLabel: 'üìÖ Calculation date',
                entriesUsedLabel: 'üö™ Entries used',
                statusLegal: '‚úÖ Legal',
                statusExhausted: '‚ö†Ô∏è Exhausted (0 days left)',
                statusViolation: '‚ùå Violation',
                statusVisaValid: '‚úÖ Visa compliant',
                statusVisaViolation: '‚ùå Visa violation',
                nextEntryText: 'üö™ Next possible legal entry:',
                errorEndDate: '‚ö†Ô∏è End date must be after start date',
                errorNoStays: 'Please enter at least one stay period.',
                errorVisaConfig: 'Please fill in all visa fields.',
                errorVisaDates: 'Visa end date must be after start date.',
                errorStayOutsideVisa: '‚ö†Ô∏è Stay outside visa period',
                tooManyEntries: 'Too many entries',
                daysOverLimit: 'Days exceeded',
                violationsTitle: 'Violations',
                remaining: 'left',
                placeholder90: 'e.g. 90',
                singleEntry: '1 (Single)',
                doubleEntry: '2 (Double)',
                multiEntry: 'MULTI (Multiple)',
                visaPeriodLabel: 'Visa Period',
                createdOn: 'Created on',
                pageInfo: 'Page 1 of 1',
                createdWith: 'Created with: Schengen Stay Calculator',
                disclaimer: 'Note: This calculation is for guidance only. For legal questions, contact the relevant authorities.',
                footerTitle: 'üõÇ Schengen Stay Calculator | 90 days in 180 days + Visa Check',
                footerIntro: 'With our free stay calculator, you can easily check how many stay days in the Schengen area you have already used, how many days you have left ‚Äì and whether you are currently legally entered.',
                footerFeatures: 'The calculation considers both:',
                footerFeature1: 'the classic 90/180-day rule (for visa-free travel)',
                footerFeature2: 'as well as stays within a Schengen visa (e.g. Type C visa with limited validity period)',
                footerWhatTitle: 'üîç What does our stay calculator do?',
                footerWhat1: 'Automatically calculates how many days you have spent in the current 180-day period',
                footerWhat2: 'Shows how many stay days are left',
                footerWhat3: 'Also checks whether you are using your Schengen visa correctly if needed',
                footerWhat4: 'Indicates when a legal re-entry is possible again',
                footerWhatNote: 'You simply enter your individual entry and exit dates ‚Äì the tool takes care of everything else.',
                footerWhoTitle: 'üë§ Who is the calculator useful for?',
                footerWho1: 'Tourists with visa-free entry (e.g. from UK, USA, Canada, Australia)',
                footerWho2: 'Visa holders who must comply with their 90 days within the visa period',
                footerWho3: 'Digital nomads, business travelers, au pairs',
                footerWho4: 'Anyone who wants to travel legally in the Schengen area',
                footerBenefit1: '‚úî The calculation is done directly in the browser ‚Äì no data storage, no registration required.',
                footerBenefit2: '‚úî Ideal for planning, documentation or proof to authorities.',
                controlDateLabel: 'Control date (calculation from):',
                incompleteDataWarning: 'Your input contains incomplete stays (missing entry or exit dates). Missing exits are assumed to last until the next entry or the control date.'
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;

            document.querySelectorAll('.language-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            for (const [key, value] of Object.entries(translations[lang])) {
                const element = document.getElementById(key);
                if (element) {
                    element.innerHTML = value;
                }
            }

            const allowedDaysInput = document.getElementById('allowedDays');
            if (allowedDaysInput) {
                allowedDaysInput.placeholder = translations[lang].placeholder90;
            }

            const singleEntry = document.getElementById('singleEntry');
            const doubleEntry = document.getElementById('doubleEntry');
            const multiEntry = document.getElementById('multiEntry');

            if (singleEntry) singleEntry.textContent = translations[lang].singleEntry;
            if (doubleEntry) doubleEntry.textContent = translations[lang].doubleEntry;
            if (multiEntry) multiEntry.textContent = translations[lang].multiEntry;

            generateStayEntries();
            updatePeriodDisplay();
        }

        function updatePeriodDisplay() {
            const periodStart = document.getElementById('periodStart');
            const periodEnd = document.getElementById('periodEnd');
            const periodNote = document.getElementById('periodNote');
            const controlInput = document.getElementById('controlDateInput');

            if (currentMode === 'schengen') {
                const controlDate = getControlDate();
                const period180Start = new Date(controlDate);
                period180Start.setDate(period180Start.getDate() - 180);

                const locale = currentLanguage === 'de' ? 'de-DE' : 'en-GB';
                const today = getTodayMEZDateOnly();

                periodStart.textContent = period180Start.toLocaleDateString(locale);

                let endText = controlDate.toLocaleDateString(locale);
                const controlIsToday = controlInput && controlInput.value &&
                    new Date(controlInput.value).getTime() === today.getTime();

                if (!controlInput.value || controlIsToday) {
                    endText += ` (${translations[currentLanguage].todayMEZ})`;
                }

                periodEnd.textContent = endText;
                periodNote.textContent = translations[currentLanguage].calculationPeriodSchengen;
            } else {
                const visaStart = document.getElementById('visaStart')?.value;
                const visaEnd = document.getElementById('visaEnd')?.value;

                if (visaStart && visaEnd) {
                    const startDate = new Date(visaStart);
                    const endDate = new Date(visaEnd);

                    periodStart.textContent = startDate.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB');
                    periodEnd.textContent = endDate.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB');
                    periodNote.textContent = currentLanguage === 'de'
                        ? 'Alle Aufenthalte m√ºssen innerhalb dieses Visum-Zeitraums liegen'
                        : 'All stays must be within this visa period';
                } else {
                    periodStart.textContent = '-';
                    periodEnd.textContent = '-';
                    periodNote.textContent = translations[currentLanguage].calculationPeriodVisa;
                }
            }
        }

        function toggleMode() {
            const modeSwitch = document.getElementById('modeSwitch');
            const schengenMode = document.getElementById('schengenMode');
            const visaMode = document.getElementById('visaMode');
            const results = document.getElementById('results');

            visibleEntries = 1;
            visibleExits = 1;

            if (modeSwitch.checked) {
                currentMode = 'visa';
                schengenMode.classList.remove('active');
                visaMode.classList.add('active');
            } else {
                currentMode = 'schengen';
                schengenMode.classList.add('active');
                visaMode.classList.remove('active');
            }

            results.classList.add('hidden');
            generateStayEntries();
            updatePeriodDisplay();
        }

        function saveCurrentInputs() {
            const savedData = {};

            for (let i = 1; i <= 10; i++) {
                const entryInput = document.getElementById(`${currentMode}Entry${i}`);
                if (entryInput) {
                    savedData[`${currentMode}Entry${i}`] = entryInput.value;
                }
            }

            for (let i = 1; i <= 10; i++) {
                const exitInput = document.getElementById(`${currentMode}Exit${i}`);
                if (exitInput) {
                    savedData[`${currentMode}Exit${i}`] = exitInput.value;
                }
            }

            return savedData;
        }

        function restoreInputs(savedData) {
            for (const [id, value] of Object.entries(savedData)) {
                const input = document.getElementById(id);
                if (input && value) {
                    input.value = value;
                }
            }
            calculateStayPeriods();
        }

        
        function calculateStayPeriods() {
            const entries = [];
            const exits = [];

            // Collect entry dates
            for (let i = 1; i <= 10; i++) {
                const entryInput = document.getElementById(`${currentMode}Entry${i}`);
                if (entryInput && entryInput.value) {
                    entries.push({
                        date: new Date(entryInput.value),
                        index: i
                    });
                }
            }

            // Collect exit dates
            for (let i = 1; i <= 10; i++) {
                const exitInput = document.getElementById(`${currentMode}Exit${i}`);
                if (exitInput && exitInput.value) {
                    exits.push({
                        date: new Date(exitInput.value),
                        index: i
                    });
                }
            }

            // Sort by date
            entries.sort((a, b) => a.date.getTime() - b.date.getTime());
            exits.sort((a, b) => a.date.getTime() - b.date.getTime());

            const stayPeriods = [];
            let hasIncomplete = false;

            if (entries.length === 0) {
                // No entries but maybe exits -> mark as incomplete but continue
                if (exits.length > 0) {
                    hasIncomplete = true;
                }
                displayCalculatedStays(stayPeriods);
                return { stayPeriods, hasIncomplete };
            }

            let exitPointer = 0;
            const controlDate = getControlDate();

            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                let exitDate = null;
                let usedRealExit = false;

                // Skip exits that are before this entry (unmatched exits)
                while (exitPointer < exits.length && exits[exitPointer].date < entry.date) {
                    hasIncomplete = true;
                    exitPointer++;
                }

                // Try to match next exit on or after entry date
                if (exitPointer < exits.length && exits[exitPointer].date >= entry.date) {
                    exitDate = exits[exitPointer].date;
                    usedRealExit = true;
                    exitPointer++;
                } else {
                    // No real exit available -> estimate
                    hasIncomplete = true;

                    if (i + 1 < entries.length) {
                        // Use next entry date as substitute end of this stay
                        exitDate = new Date(entries[i + 1].date);
                    } else {
                        // Last entry without exit -> use control date
                        exitDate = new Date(controlDate);
                    }
                }

                // Safety: never allow negative duration
                if (exitDate < entry.date) {
                    exitDate = new Date(entry.date);
                }

                const timeDiff = exitDate.getTime() - entry.date.getTime();
                const days = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;

        // --- NEUE HILFSFUNKTION: Verhindert Doppelz√§hlung von Tagen ---
        function countUniqueDays(stays, periodStart, periodEnd) {
            const uniqueDays = new Set();
            
            // Konvertiere Grenzen in Timestamps f√ºr Vergleich
            const startLimit = periodStart ? periodStart.getTime() : -Infinity;
            const endLimit = periodEnd ? periodEnd.getTime() : Infinity;

            stays.forEach(stay => {
                // Iteriere durch jeden Tag des Aufenthalts
                let current = new Date(stay.start);
                const end = new Date(stay.end);

                while (current <= end) {
                    const currentTs = current.getTime();
                    
                    // Pr√ºfen ob der Tag im relevanten Fenster liegt (z.B. 180 Tage)
                    if (currentTs >= startLimit && currentTs <= endLimit) {
                        // Speichere als String "YYYY-MM-DD" um Duplikate im Set automatisch zu filtern
                        uniqueDays.add(current.toISOString().split('T')[0]);
                    }
                    
                    // Einen Tag weiterz√§hlen
                    current.setDate(current.getDate() + 1);
                }
            });

            return uniqueDays.size;
        }

        // --- √úBERARBEITETE FUNKTION: Logik f√ºr L√ºckenf√ºllung ---
        function calculateStayPeriods() {
            const stayPeriods = [];
            let hasIncomplete = false;
            const controlDate = getControlDate();

            // Wir sammeln alle Zeilen (1-10)
            let rawRows = [];
            for (let i = 1; i <= 10; i++) {
                const entryInput = document.getElementById(`${currentMode}Entry${i}`);
                const exitInput = document.getElementById(`${currentMode}Exit${i}`);
                
                // Wir betrachten eine Zeile als relevant, wenn zumindest ein Feld ausgef√ºllt ist
                if ((entryInput && entryInput.value) || (exitInput && exitInput.value)) {
                    rawRows.push({
                        index: i,
                        entryDate: entryInput.value ? new Date(entryInput.value) : null,
                        exitDate: exitInput.value ? new Date(exitInput.value) : null
                    });
                }
            }

            // Nach Einreise sortieren (falls vorhanden), sonst Index behalten
            rawRows.sort((a, b) => {
                if(a.entryDate && b.entryDate) return a.entryDate - b.entryDate;
                return a.index - b.index;
            });

            for (let i = 0; i < rawRows.length; i++) {
                let row = rawRows[i];
                let entryDate = row.entryDate;
                let exitDate = row.exitDate;
                let isEstimated = false;

                // 1. FEHLENDE EINREISE
                // Logik: Wenn Einreise fehlt, nimm Ausreise der vorherigen Zeile
                if (!entryDate && exitDate) {
                    if (i > 0 && stayPeriods[i-1].exitDate) {
                        entryDate = new Date(stayPeriods[i-1].exitDate); // Kopie erstellen
                        isEstimated = true;
                    } else {
                        // Kein Vorg√§nger? Dann kann nicht berechnet werden (oder Startdatum Visum/ControlDate - hier lassen wir es leer -> Fehler)
                        // Option: Wir k√∂nnten das Startdatum des Visums nehmen, aber das ist spekulativ.
                        // Wir setzen es auf ExitDate (1 Tag Aufenthalt) als Fallback
                        entryDate = new Date(exitDate);
                        isEstimated = true;
                    }
                }

                // 2. FEHLENDE AUSREISE
                // Logik: Wenn Ausreise fehlt, nimm Einreise der n√§chsten Zeile ODER Kontrolldatum
                if (entryDate && !exitDate) {
                    isEstimated = true;
                    // Gibt es eine n√§chste Zeile mit Einreise?
                    if (i + 1 < rawRows.length && rawRows[i+1].entryDate) {
                        exitDate = new Date(rawRows[i+1].entryDate);
                    } else {
                        // Letzter Eintrag oder kein Nachfolger -> Bis zum Kontrolldatum
                        exitDate = new Date(controlDate);
                    }
                }

                // Falls wir nun beide Daten haben
                if (entryDate && exitDate) {
                    // Validierung: Ausreise darf nicht vor Einreise sein
                    if (exitDate < entryDate) {
                        exitDate = new Date(entryDate); 
                    }

                    // Dauer berechnen
                    const timeDiff = exitDate.getTime() - entryDate.getTime();
                    const days = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;

                    stayPeriods.push({
                        number: stayPeriods.length + 1,
                        entryDate: entryDate,
                        exitDate: exitDate,
                        days: days,
                        estimated: isEstimated, // Markierung f√ºr rote Umrandung
                        originalIndex: row.index
                    });

                    if (isEstimated) hasIncomplete = true;
                }
            }

            displayCalculatedStays(stayPeriods);
            return { stayPeriods, hasIncomplete };
        }

        // --- √úBERARBEITETE ANZEIGE: Rote Umrandung hinzuf√ºgen ---
        function displayCalculatedStays(stayPeriods) {
            const containerId = currentMode === 'schengen' ? 'schengenCalculatedStays' : 'visaCalculatedStays';
            const container = document.getElementById(containerId);

            if (!container) return;

            if (stayPeriods.length === 0) {
                container.innerHTML = `
                    <div class="calculated-stays-empty">
                        <p>${translations[currentLanguage].emptyStaysMessage}</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="calculated-stays">
                    <h3>${translations[currentLanguage].calculatedStaysTitle}</h3>
                    <div class="stays-list">
            `;

            stayPeriods.forEach(stay => {
                // Klasse 'stay-incomplete' hinzuf√ºgen, wenn Daten gesch√§tzt wurden
                const incompleteClass = stay.estimated ? 'stay-incomplete' : '';
                const incompleteBadge = stay.estimated 
                    ? `<span class="stay-incomplete-badge">‚ö†Ô∏è Daten unvollst√§ndig (erg√§nzt)</span>` 
                    : '';

                html += `
                    <div class="calculated-stay-item ${incompleteClass}">
                        <div class="stay-number">${stay.number}</div>
                        <div class="stay-details">
                            <div class="stay-period">
                                ${stay.entryDate.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB')} ‚Üí 
                                ${stay.exitDate.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB')}
                            </div>
                            <div class="stay-duration">
                                ${stay.days} ${stay.days === 1 ? translations[currentLanguage].daysText : translations[currentLanguage].daysTextPlural}
                            </div>
                            ${incompleteBadge}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateStayEntries() {
            const containerId = currentMode === 'schengen' ? 'schengenStayEntries' : 'visaStayEntries';
            const container = document.getElementById(containerId);

            const savedData = saveCurrentInputs();

            container.innerHTML = '';

            let entriesHTML = `
                <div class="entries-section">
                    <h3>üõ¨ ${translations[currentLanguage].entryHeading}</h3>
                    <div class="entries-grid">
            `;

            for (let i = 1; i <= visibleEntries; i++) {
                const deleteButton = i > 1 ? `
                    <button type="button" class="delete-entry-btn" onclick="removeEntry(${i})" title="${translations[currentLanguage].entryLabel} entfernen">
                        üóëÔ∏è
                    </button>
                ` : '';

                entriesHTML += `
                    <div class="entry-item">
                        <div class="entry-header">
                            <label>${translations[currentLanguage].entryLabel} ${i}</label>
                            ${deleteButton}
                        </div>
                        <input type="date" id="${currentMode}Entry${i}" onchange="calculateStayPeriods()">
                    </div>
                `;
            }

            if (visibleEntries < 10) {
                entriesHTML += `
                    <div class="add-entry-section">
                        <button type="button" class="add-entry-btn" onclick="addEntry()">
                            ${translations[currentLanguage].addEntryBtn}
                        </button>
                    </div>
                `;
            }

            entriesHTML += `
                    </div>
                </div>
            `;

            let exitsHTML = `
                <div class="exits-section">
                    <h3>üõ´ ${translations[currentLanguage].exitHeading}</h3>
                    <div class="exits-grid">
            `;

            for (let i = 1; i <= visibleExits; i++) {
                const deleteButton = i > 1 ? `
                    <button type="button" class="delete-exit-btn" onclick="removeExit(${i})" title="${translations[currentLanguage].exitLabel} entfernen">
                        üóëÔ∏è
                    </button>
                ` : '';

                exitsHTML += `
                    <div class="exit-item">
                        <div class="exit-header">
                            <label>${translations[currentLanguage].exitLabel} ${i}</label>
                            ${deleteButton}
                        </div>
                        <input type="date" id="${currentMode}Exit${i}" onchange="calculateStayPeriods()">
                    </div>
                `;
            }

            if (visibleExits < 10) {
                exitsHTML += `
                    <div class="add-exit-section">
                        <button type="button" class="add-exit-btn" onclick="addExit()">
                            ${translations[currentLanguage].addExitBtn}
                        </button>
                    </div>
                `;
            }

            exitsHTML += `
                    </div>
                </div>
            `;

            const calculatedStaysHTML = `
                <div id="${currentMode}CalculatedStays" class="calculated-stays-container">
                </div>
            `;

            container.innerHTML = entriesHTML + exitsHTML + calculatedStaysHTML;

            setTimeout(() => {
                restoreInputs(savedData);
            }, 10);
        }

        function addEntry() {
            if (visibleEntries < 10) {
                visibleEntries++;
                generateStayEntries();
            }
        }

        function addExit() {
            if (visibleExits < 10) {
                visibleExits++;
                generateStayEntries();
            }
        }

        function removeEntry(entryIndex) {
            if (visibleEntries > 1 && entryIndex > 1) {
                const savedData = saveCurrentInputs();

                delete savedData[`${currentMode}Entry${entryIndex}`];

                const adjustedData = {};
                for (const [key, value] of Object.entries(savedData)) {
                    const match = key.match(/(\w+)(Entry|Exit)(\d+)/);
                    if (match) {
                        const mode = match[1];
                        const type = match[2];
                        const index = parseInt(match[3]);

                        if (type === 'Entry') {
                            if (index < entryIndex) {
                                adjustedData[key] = value;
                            } else if (index > entryIndex) {
                                const newKey = `${mode}${type}${index - 1}`;
                                adjustedData[newKey] = value;
                            }
                        } else {
                            adjustedData[key] = value;
                        }
                    }
                }

                visibleEntries--;
                generateStayEntries();

                setTimeout(() => {
                    restoreInputs(adjustedData);
                }, 10);
            }
        }

        function removeExit(exitIndex) {
            if (visibleExits > 1 && exitIndex > 1) {
                const savedData = saveCurrentInputs();

                delete savedData[`${currentMode}Exit${exitIndex}`];

                const adjustedData = {};
                for (const [key, value] of Object.entries(savedData)) {
                    const match = key.match(/(\w+)(Entry|Exit)(\d+)/);
                    if (match) {
                        const mode = match[1];
                        const type = match[2];
                        const index = parseInt(match[3]);

                        if (type === 'Exit') {
                            if (index < exitIndex) {
                                adjustedData[key] = value;
                            } else if (index > exitIndex) {
                                const newKey = `${mode}${type}${index - 1}`;
                                adjustedData[newKey] = value;
                            }
                        } else {
                            adjustedData[key] = value;
                        }
                    }
                }

                visibleExits--;
                generateStayEntries();

                setTimeout(() => {
                    restoreInputs(adjustedData);
                }, 10);
            }
        }

        // --- √úBERARBEITETE SCHENGEN BERECHNUNG: Nutzt countUniqueDays ---
        function calculateSchengen() {
            const { stayPeriods, hasIncomplete } = calculateStayPeriods();

            // Mapping auf vereinfachte Struktur
            const stays = stayPeriods.map(period => ({
                start: period.entryDate,
                end: period.exitDate
            }));

            const referenceDate = getControlDate();
            const period180Start = new Date(referenceDate);
            period180Start.setDate(period180Start.getDate() - 180); // Genauer: R√ºckrechnung um 180 Tage (exklusiv heute? Nein, inklusiv)
            // Die 180-Tage-Periode endet am referenceDate. Sie beginnt referenceDate - 179 Tage.
            // Schengen Rechner nehmen oft referenceDate - 180 Tage als Startpunkt des Fensters zur Pr√ºfung.
            
            // NEU: Berechnung der eindeutigen Tage im Fenster √ºber Set (keine Doppelz√§hlung)
            const daysInPeriod = countUniqueDays(stays, period180Start, referenceDate);
            
            const remainingDays = 90 - daysInPeriod;
            const isLegal = daysInPeriod <= 90;

            const calculationPeriod = {
                start: period180Start,
                end: referenceDate,
                mode: 'schengen'
            };

            let allowedUntil = null;
            if (remainingDays > 0 && isLegal) {
                // Wir m√ºssen vorsichtig sein. "Erlaubt bis" ist komplex bei gleitenden Fenstern.
                // Vereinfachte Annahme f√ºr User: Ab ReferenceDate + RemainingDays.
                allowedUntil = new Date(referenceDate);
                allowedUntil.setDate(allowedUntil.getDate() + remainingDays - 1);
            }

            let nextEntryDate = null;
            if (!isLegal || remainingDays <= 0) {
                // Einfache Heuristik f√ºr n√§chsten Einreisetag:
                // Wann wird der √§lteste Tag im Fenster "frei"?
                // Wir nehmen den ersten Tag des relevantesten Aufenthalts + 180 Tage.
                // (Dies ist eine Vereinfachung, eine exakte Berechnung der "Wiedereinreise" erfordert Iteration in die Zukunft)
                
                // Filtere Stays die im Fenster liegen
                const relevantStays = stays.filter(s => s.end >= period180Start && s.start <= referenceDate);
                relevantStays.sort((a,b) => a.start - b.start);
                
                if (relevantStays.length > 0) {
                    // Der Tag, an dem der erste Aufenthalt "verf√§llt" (aus dem 180 Tage Fenster f√§llt)
                    const firstRelevantEntry = relevantStays[0].start < period180Start ? period180Start : relevantStays[0].start;
                    nextEntryDate = new Date(firstRelevantEntry);
                    nextEntryDate.setDate(nextEntryDate.getDate() + 180);
                }
            }

            displaySchengenResults(daysInPeriod, remainingDays, isLegal, allowedUntil, nextEntryDate, referenceDate, calculationPeriod, hasIncomplete);
        }

        // --- √úBERARBEITETE VISUM BERECHNUNG: Nutzt countUniqueDays ---
        function calculateVisa() {
            const visaStart = document.getElementById('visaStart').value;
            const visaEnd = document.getElementById('visaEnd').value;
            const allowedDays = parseInt(document.getElementById('allowedDays').value);
            const allowedEntries = document.getElementById('allowedEntries').value;

            if (!visaStart || !visaEnd || !allowedDays) {
                alert(translations[currentLanguage].errorVisaConfig);
                return;
            }

            const visaStartDate = new Date(visaStart);
            const visaEndDate = new Date(visaEnd);

            if (visaEndDate <= visaStartDate) {
                alert(translations[currentLanguage].errorVisaDates);
                return;
            }

            const { stayPeriods, hasIncomplete } = calculateStayPeriods();

            // Mapping
            const stays = stayPeriods.map(period => ({
                start: period.entryDate,
                end: period.exitDate
            }));

            let entriesUsed = stayPeriods.length;
            let violations = [];

            // Pr√ºfen ob Aufenthalte au√üerhalb des Visums liegen
            stayPeriods.forEach((stay, index) => {
                if (stay.entryDate < visaStartDate || stay.exitDate > visaEndDate) {
                    violations.push(`${translations[currentLanguage].stayLabel} ${index + 1}: ${translations[currentLanguage].errorStayOutsideVisa}`);
                }
            });

            // NEU: Eindeutige Tage z√§hlen (verhindert Doppelz√§hlung)
            // Nur Tage z√§hlen, die auch innerhalb des Visums liegen
            const totalDays = countUniqueDays(stays, visaStartDate, visaEndDate);

            let isCompliant = true;

            if (allowedEntries !== 'multi' && entriesUsed > parseInt(allowedEntries)) {
                violations.push(`${translations[currentLanguage].tooManyEntries}: ${entriesUsed}/${allowedEntries}`);
                isCompliant = false;
            }

            if (totalDays > allowedDays) {
                violations.push(`${translations[currentLanguage].daysOverLimit}: ${totalDays}/${allowedDays}`);
                isCompliant = false;
            }
            
            if (violations.length > 0) {
                isCompliant = false;
            }

            const remainingDays = Math.max(0, allowedDays - totalDays);
            const controlDate = getControlDate();
            
            // "Erlaubt bis" Berechnung
            let allowedUntil = null;
            if (remainingDays > 0) {
                 // Startpunkt ist entweder ControlDate oder VisaStart (falls ControlDate davor liegt)
                let effectiveStart = controlDate < visaStartDate ? visaStartDate : controlDate;
                
                // Addiere verbleibende Tage
                allowedUntil = new Date(effectiveStart);
                allowedUntil.setDate(allowedUntil.getDate() + remainingDays - 1); // -1 da der Starttag mitz√§hlt

                // Darf nicht l√§nger als Visumende sein
                if (allowedUntil > visaEndDate) {
                    allowedUntil = visaEndDate;
                }
            }

            calculationPeriodData = {
                start: visaStartDate,
                end: visaEndDate,
                mode: 'visa'
            };

            displayVisaResults(totalDays, allowedDays, remainingDays, entriesUsed, allowedEntries, isCompliant, violations, visaStartDate, visaEndDate, allowedUntil, controlDate, hasIncomplete);
        }

        function displaySchengenResults(usedDays, remainingDays, isLegal, allowedUntil, nextEntryDate, referenceDate, calculationPeriod, hasIncomplete) {
            calculationPeriodData = calculationPeriod;

            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');

            let statusText, statusClass;
            if (isLegal && remainingDays > 0) {
                statusText = `${translations[currentLanguage].statusLegal} (${remainingDays} ${translations[currentLanguage].daysTextPlural} ${translations[currentLanguage].remaining})`;
                statusClass = 'status-legal';
            } else if (isLegal && remainingDays === 0) {
                statusText = translations[currentLanguage].statusExhausted;
                statusClass = 'status-warning';
            } else {
                statusText = translations[currentLanguage].statusViolation;
                statusClass = 'status-illegal';
            }

            const locale = currentLanguage === 'de' ? 'de-DE' : 'en-GB';
            const allowedUntilText = allowedUntil
                ? allowedUntil.toLocaleDateString(locale)
                : '‚Äî';

            resultsList.innerHTML = `
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].usedDaysLabel}</span>
                    <span class="result-value">${usedDays} / 90 ${translations[currentLanguage].daysTextPlural}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].remainingDaysLabel}</span>
                    <span class="result-value">${Math.max(0, remainingDays)} ${translations[currentLanguage].daysTextPlural}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].allowedStayUntilLabel}</span>
                    <span class="result-value">${allowedUntilText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].statusLabel}</span>
                    <span class="result-value ${statusClass}">${statusText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].calculationDateLabel}</span>
                    <span class="result-value">${referenceDate.toLocaleDateString(locale)}</span>
                </div>
            `;

            if (nextEntryDate) {
                resultsList.innerHTML += `
                    <div class="next-entry-date">
                        ${translations[currentLanguage].nextEntryText} <strong>${nextEntryDate.toLocaleDateString(locale)}</strong>
                    </div>
                `;
            }

            if (hasIncomplete) {
                resultsList.innerHTML += `
                    <div class="next-entry-date">
                        ‚ö†Ô∏è ${translations[currentLanguage].incompleteDataWarning}
                    </div>
                `;
            }

            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displayVisaResults(usedDays, allowedDays, remainingDays, entriesUsed, allowedEntries, isCompliant, violations, visaStart, visaEnd, allowedUntil, controlDate, hasIncomplete) {
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');

            const statusText = isCompliant ? translations[currentLanguage].statusVisaValid : translations[currentLanguage].statusVisaViolation;
            const statusClass = isCompliant ? 'status-legal' : 'status-illegal';
            const entriesText = allowedEntries === 'multi' ? 'MULTI' : allowedEntries;

            const locale = currentLanguage === 'de' ? 'de-DE' : 'en-GB';
            const allowedUntilText = allowedUntil
                ? allowedUntil.toLocaleDateString(locale)
                : '‚Äî';

            resultsList.innerHTML = `
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].usedDaysVisaLabel}</span>
                    <span class="result-value">${usedDays} / ${allowedDays} ${translations[currentLanguage].daysTextPlural}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].remainingDaysLabel}</span>
                    <span class="result-value">${remainingDays} ${translations[currentLanguage].daysTextPlural}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].allowedStayUntilLabel}</span>
                    <span class="result-value">${allowedUntilText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].entriesUsedLabel}</span>
                    <span class="result-value">${entriesUsed} / ${entriesText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].statusLabel}</span>
                    <span class="result-value ${statusClass}">${statusText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">üóìÔ∏è ${translations[currentLanguage].visaPeriodLabel}</span>
                    <span class="result-value">${visaStart.toLocaleDateString(locale)} - ${visaEnd.toLocaleDateString(locale)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${translations[currentLanguage].calculationDateLabel}</span>
                    <span class="result-value">${controlDate.toLocaleDateString(locale)}</span>
                </div>
            `;

            if (violations.length > 0) {
                resultsList.innerHTML += `
                    <div class="next-entry-date">
                        <strong>‚ö†Ô∏è ${translations[currentLanguage].violationsTitle}:</strong><br>
                        ${violations.join('<br>')}
                    </div>
                `;
            }

            if (hasIncomplete) {
                resultsList.innerHTML += `
                    <div class="next-entry-date">
                        ‚ö†Ô∏è ${translations[currentLanguage].incompleteDataWarning}
                    </div>
                `;
            }

            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function collectEnteredStays() {
            const { stayPeriods } = calculateStayPeriods();

            return stayPeriods.map(stay => ({
                number: stay.number,
                startDate: stay.entryDate.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB'),
                endDate: stay.exitDate.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB'),
                days: stay.days
            }));
        }

        function printResults() {
    try {
        const resultsDiv = document.getElementById('results');
        const resultsList = document.getElementById('resultsList');

        // Wenn noch nichts berechnet wurde
        if (!resultsDiv || resultsDiv.classList.contains('hidden') || !resultsList) {
            alert(currentLanguage === 'de'
                ? 'Bitte zuerst eine Berechnung durchf√ºhren.'
                : 'Please run a calculation first.');
            return;
        }

        const enteredStays = collectEnteredStays();

        const now = getTodayMEZ();
        const printDate = now.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB') +
                         ' ' + now.toLocaleTimeString(currentLanguage === 'de' ? 'de-DE' : 'en-GB');

        const printTitle = currentMode === 'schengen'
            ? (currentLanguage === 'de'
                ? 'SCHENGEN AUFENTHALTSBERECHNUNG (90/180 Tage)'
                : 'SCHENGEN STAY CALCULATION (90/180 days)')
            : (currentLanguage === 'de'
                ? 'VISUM AUFENTHALTSBERECHNUNG'
                : 'VISA STAY CALCULATION');

        const printHTML = createPrintHTML(
            printTitle,
            printDate,
            resultsList.innerHTML,
            enteredStays,
            calculationPeriodData
        );

        const printWindow = window.open('', '_blank', 'width=900,height=650,scrollbars=yes');

        if (!printWindow) {
            // Popup geblockt ‚Üí Fallback Text-Export
            showTextExport();
            return;
        }

        // WICHTIG: erst √∂ffnen, dann schreiben, dann schlie√üen
        printWindow.document.open();
        printWindow.document.write(printHTML);
        printWindow.document.close();

        // Fokus setzen & mit kleinem Delay drucken (hilft bei Chrome/Firefox)
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            // Fenster optional automatisch schlie√üen
            // printWindow.close();
        }, 300);

    } catch (error) {
        console.error('Print error:', error);
        showTextExport();
    }
}

        function createPrintHTML(title, date, resultsHTML, enteredStays, calculationPeriod) {
            const disclaimerText = translations[currentLanguage].disclaimer;
            const footerText = translations[currentLanguage].createdWith;

            const staysOverviewTitle = translations[currentLanguage].stayOverviewTitle;
            const arrivalLabel = translations[currentLanguage].arrivalLabel;
            const departureLabel = translations[currentLanguage].departureLabel;
            const daysTextPlural = translations[currentLanguage].daysTextPlural;

            let calculationPeriodHTML = '';
            if (calculationPeriod) {
                const periodStart = calculationPeriod.start.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB');
                const periodEnd = calculationPeriod.end.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB');

                let periodTitle, periodNote;
                if (calculationPeriod.mode === 'schengen') {
                    periodTitle = currentLanguage === 'de' ? 'Berechnungszeitraum (180 Tage)' : 'Calculation Period (180 days)';
                    periodNote = currentLanguage === 'de' ? 'Aufenthaltstage in diesem Zeitraum werden f√ºr die 90/180-Tage-Regel ber√ºcksichtigt.' : 'Stay days in this period are considered for the 90/180 day rule.';
                } else {
                    periodTitle = currentLanguage === 'de' ? 'Visum-G√ºltigkeitszeitraum' : 'Visa Validity Period';
                    periodNote = currentLanguage === 'de' ? 'Alle Aufenthalte m√ºssen innerhalb dieses Zeitraums liegen.' : 'All stays must be within this period.';
                }

                calculationPeriodHTML = `
                    <div class="calculation-period">
                        <h2>${periodTitle}</h2>
                        <div class="period-info">
                            <strong>${periodStart} ‚Üí ${periodEnd}</strong>
                            <p>${periodNote}</p>
                        </div>
                    </div>
                `;
            }

            let staysTableHTML = '';
            if (enteredStays.length > 0) {
                staysTableHTML = `
                    <div class="stays-overview">
                        <h2>${staysOverviewTitle}</h2>
                        <table class="stays-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>${arrivalLabel}</th>
                                    <th>${departureLabel}</th>
                                    <th>${daysTextPlural}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                enteredStays.forEach(stay => {
                    staysTableHTML += `
                        <tr>
                            <td>${stay.number}</td>
                            <td>${stay.startDate}</td>
                            <td>${stay.endDate}</td>
                            <td>${stay.days}</td>
                        </tr>
                    `;
                });

                staysTableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            return `
<!DOCTYPE html>
<html lang="${currentLanguage}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            color: black;
            margin: 0;
            padding: 20px;
            background: white;
        }
        .header {
            text-align: center;
            border-bottom: 3px solid black;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 18pt;
            font-weight: bold;
            margin: 0 0 10px 0;
        }
        .header .date {
            font-size: 11pt;
            color: #666;
        }
        .calculation-period {
            background: #f0f8ff;
            border: 2px solid #4169e1;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }
        .calculation-period h2 {
            font-size: 14pt;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #1e3a8a;
        }
        .period-info {
            text-align: center;
        }
        .period-info strong {
            font-size: 13pt;
            color: #1e40af;
            display: block;
            margin-bottom: 5px;
        }
        .period-info p {
            font-size: 10pt;
            color: #666;
            margin: 0;
            font-style: italic;
        }
        .stays-overview {
            margin-bottom: 30px;
        }
        .stays-overview h2 {
            font-size: 14pt;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 8px;
        }
        .stays-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .stays-table th, .stays-table td {
            border: 1px solid #999;
            padding: 8px 12px;
            text-align: left;
        }
        .stays-table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
        }
        .stays-table td:first-child {
            text-align: center;
            font-weight: bold;
        }
        .stays-table td:last-child {
            text-align: center;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }
        .result-label {
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        .result-value {
            font-weight: bold;
            text-align: right;
            flex: 1;
        }
        .status-legal { color: #2d5a2d; }
        .status-illegal { color: #8b0000; }
        .status-warning { color: #8b6914; }
        .next-entry-date {
            background: #f5f5f5;
            border: 1px solid #999;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            border-radius: 5px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            font-size: 9pt;
            color: #666;
            text-align: center;
        }
        .disclaimer {
            font-style: italic;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>${title}</h1>
        <div class="date">${translations[currentLanguage].createdOn}: ${date}</div>
    </div>

    ${calculationPeriodHTML}

    ${staysTableHTML}

    <div class="results">
        ${resultsHTML}
    </div>

    <div class="footer">
        <div class="disclaimer">${disclaimerText}</div>
        <div>${footerText} | ${translations[currentLanguage].pageInfo}</div>
    </div>
</body>
</html>`;
        }

        function showTextExport() {
            const resultsDiv = document.getElementById('results');
            const resultItems = resultsDiv.querySelectorAll('.result-item');

            const enteredStays = collectEnteredStays();

            let textContent = currentMode === 'schengen' 
                ? (currentLanguage === 'de' ? 'SCHENGEN AUFENTHALTSBERECHNUNG (90/180 Tage)' : 'SCHENGEN STAY CALCULATION (90/180 days)')
                : (currentLanguage === 'de' ? 'VISUM AUFENTHALTSBERECHNUNG' : 'VISA STAY CALCULATION');

            textContent += '\n' + '='.repeat(60) + '\n\n';
            textContent += translations[currentLanguage].createdOn + ': ' + getTodayMEZ().toLocaleString(currentLanguage === 'de' ? 'de-DE' : 'en-GB') + '\n\n';

            if (calculationPeriodData) {
                const periodStart = calculationPeriodData.start.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB');
                const periodEnd = calculationPeriodData.end.toLocaleDateString(currentLanguage === 'de' ? 'de-DE' : 'en-GB');

                let periodTitle, periodNote;
                if (calculationPeriodData.mode === 'schengen') {
                    periodTitle = currentLanguage === 'de' ? 'BERECHNUNGSZEITRAUM (180 Tage)' : 'CALCULATION PERIOD (180 days)';
                    periodNote = currentLanguage === 'de' ? 'Aufenthaltstage in diesem Zeitraum werden f√ºr die 90/180-Tage-Regel ber√ºcksichtigt.' : 'Stay days in this period are considered for the 90/180 day rule.';
                } else {
                    periodTitle = currentLanguage === 'de' ? 'VISUM-G√úLTIGKEITSZEITRAUM' : 'VISA VALIDITY PERIOD';
                    periodNote = currentLanguage === 'de' ? 'Alle Aufenthalte m√ºssen innerhalb dieses Zeitraums liegen.' : 'All stays must be within this period.';
                }

                textContent += `${periodTitle}:\n`;
                textContent += `${periodStart} ‚Üí ${periodEnd}\n`;
                textContent += `${periodNote}\n\n`;
            }

            if (enteredStays.length > 0) {
                textContent += translations[currentLanguage].stayOverviewTitle + ':\n';
                textContent += '-'.repeat(40) + '\n';
                enteredStays.forEach(stay => {
                    textContent += `${stay.number}. ${stay.startDate} - ${stay.endDate} (${stay.days} ${translations[currentLanguage].daysTextPlural})\n`;
                });
                textContent += '\n';
            }

            textContent += 'BERECHNUNGSERGEBNIS:\n';
            textContent += '-'.repeat(40) + '\n';

            resultItems.forEach(item => {
                const label = item.querySelector('.result-label')?.textContent || '';
                const value = item.querySelector('.result-value')?.textContent || '';
                textContent += `${label}: ${value}\n`;
            });

            const nextEntry = resultsDiv.querySelector('.next-entry-date');
            if (nextEntry) {
                textContent += '\n' + nextEntry.textContent + '\n';
            }

            textContent += '\n' + '='.repeat(60) + '\n';
            textContent += translations[currentLanguage].disclaimer;

            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'schengen-berechnung.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(currentLanguage === 'de' 
                ? 'Die Berechnung wurde als Textdatei heruntergeladen.' 
                : 'The calculation has been downloaded as a text file.');
        }

        document.addEventListener('DOMContentLoaded', function() {
            generateStayEntries();
            updatePeriodDisplay();

            const allowedDaysInput = document.getElementById('allowedDays');
            if (allowedDaysInput) {
                allowedDaysInput.placeholder = translations[currentLanguage].placeholder90;
            }

            const controlDateInput = document.getElementById('controlDateInput');
            if (controlDateInput) {
                const today = getTodayMEZDateOnly();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                controlDateInput.value = `${yyyy}-${mm}-${dd}`;
            }

            calculateStayPeriods();

            const mezToday = getTodayMEZ();
            console.log('üïê Aktuelles MEZ-Datum:', mezToday.toLocaleDateString('de-DE'), mezToday.toLocaleTimeString('de-DE'));
            console.log('üåç Browser-Zeitzone:', Intl.DateTimeFormat().resolvedOptions().timeZone);
            console.log('üìÖ Verwendetes Datum f√ºr Berechnungen:', getTodayMEZDateOnly().toLocaleDateString('de-DE'));
        });
    </script>
</body>
</html>
